#!/bin/bash
# Run with:
#     ld-report $(date "+%b %Y")

MONTH="$1"
YEAR="$2"

hadoop jar /usr/lib/hadoop-0.20/contrib/streaming/hadoop-streaming-0.20.2-cdh3u1.jar \
-mapper "sed -rn 's@^.+ Adding Lock Page.+sessionId=([^,]+), dateInitiated=[A-Z][a-z]{2} $MONTH [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} [A-Z]{3} $YEAR, page=/([^/]+)/(.+), ipAddress=.+\]\$@\1\t\2\t\3@p'" \
-input "/logs/DLS-LON-WB01/usr/local/tomcat/logs/catalina.*" \
-output "$YEAR$MONTH-dls-lon-wb01-wayback/"

NUM_PAGE_LOCKS=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-wayback/part-*" | wc -l)
NUM_UNIQUE_PAGE_LOCKS=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-wayback/part-*" | cut -d "$(printf "\t")" -f1 | sort -u | wc -l)
MOST_POPULAR_PAGE=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-wayback/part-*" | cut -d "$(printf "\t")" -f3 | sort | uniq -c | sort -rn | head -n1)


hadoop jar /usr/lib/hadoop-0.20/contrib/streaming/hadoop-streaming-0.20.2-cdh3u1.jar \
-mapper "sed -rn 's@^.+/$MONTH/$YEAR:.+GET /ukdomain/search\?text=([^ ]+)&sort_by=.+\$@\1@p'" \
-input "/logs/DLS-LON-WB01/etc/httpd/logs/access_log*" \
-output "$YEAR$MONTH-dls-lon-wb01-solr/"

NUM_SEARCHES=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-solr/part-*" | wc -l)
NUM_UNIQUE_SEARCH_TERMS=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-solr/part-*" | sort -u | wc -l)
MOST_POPULAR_SEARCH_TERM=$(hadoop fs -cat "$YEAR$MONTH-dls-lon-wb01-solr/part-*" | sort | uniq -c | sort -rn | head -n1)

echo "$MONTH $YEAR"
echo "Number of pages viewed: $NUM_PAGE_LOCKS"
echo "Number of unique visitors: $NUM_UNIQUE_PAGE_LOCKS"
echo "Most visited page: $MOST_POPULAR_PAGE"
echo "Number of searches: $NUM_SEARCHES"
echo "Number of unique search terms: $NUM_UNIQUE_SEARCH_TERMS"
echo "Most popular search term: $MOST_POPULAR_SEARCH_TERM"

