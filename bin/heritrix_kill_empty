#!/bin/bash

USER="admin"
PASSWORD="bl_uk"

HERITRIX_HOST="localhost"
HERITRIX_PORT=8443

usage()
{
		echo -ne "Will Terminate/Teardown all Heritrix jobs with an EMTPY status.\n\n"
		echo "OPTIONS:"
		echo "  -h	Show this message."
		echo "  -t      Test only."
}

heritrix()
{
	curl --silent -d "action=$1" -k -u "$USER:$PASSWORD" --anyauth --location "https://$HERITRIX_HOST:$HERITRIX_PORT/engine/$2" -H "Accept: application/xml"
}

getstatus()
{
	heritrix "none" "job/$1" | sed -rn 's@^\s*<crawlControllerState>([^<]+)</crawlControllerState>.*$@\1@p'
}

waitfor()
{
	while [[ "$(getstatus "$1")" != "$2" ]]
	do
		sleep $3
	done
}

log()
{
	echo "[$(date "+%Y-%m-%d %H:%M:%S")] $1"
}

while getopts "ht" OPTION
do
		case $OPTION in
		h)
				usage
				exit 1
				;;
		t)
				TEST=true
				;;
		esac
done

[[ -n $TEST ]] && echo "TEST:"
while read job
do
	STATUS="$(getstatus $job)"
	if [[ "$STATUS" == "EMPTY" ]]
	then
		if [[ -n $TEST ]]
		then
			echo -e "\tWould terminate job: $job"
		else
			echo "Terminating: $job"
			heritrix "terminate" "job/$job" > /dev/null
			waitfor "$job" "FINISHED" 10
			#Teardown Job
			heritrix "teardown" "job/$job" > /dev/null
			waitfor "$job" "" 10
		fi

	fi
done < <(heritrix "none" | sed -rn 's@^\s*<shortName>([^<]+)</shortName>.*$@\1@p' | grep -v "latest")
